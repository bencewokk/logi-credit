<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics - Logi Credit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../theme.css">
  <style>
    .chart-card {
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chart-card canvas {
      max-height: 100%;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <img src="../1000013760.png" alt="Logo">
      <span>Logi Credit</span>
    </div>
    <nav class="header-nav">
      <a href="../home/">Dashboard</a>
      <a href="david.html">Auth</a>
      <a href="pali.html" class="active">Analytics</a>
      <a href="kristof.html">UtalÃ¡s</a>
      <button class="theme-toggle" title="TÃ©ma vÃ¡ltÃ¡s">ğŸŒ™</button>
      <button class="logout-btn" onclick="logout()">KijelentkezÃ©s</button>
    </nav>
  </header>

  <main class="main-container">
    <!-- Header Card -->
    <div class="balance-card">
      <div class="balance-label">ğŸ“Š Analitika & StatisztikÃ¡k</div>
      <div class="balance-amount" style="font-size:32px;">Pali</div>
      <div class="balance-currency">Data Analytics & Visualization</div>
    </div>

    <!-- Stats Overview -->
    <div class="card">
      <h2 class="section-title">
        <span class="icon">ğŸ“ˆ</span>
        ÃttekintÃ©s
      </h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-transactions">0</div>
          <div class="stat-label">Ã–sszes tranzakciÃ³</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-volume">0</div>
          <div class="stat-label">Forgalom (HUF)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avg-amount">0</div>
          <div class="stat-label">Ãtlag Ã¶sszeg</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="user-count">-</div>
          <div class="stat-label">FelhasznÃ¡lÃ³k</div>
        </div>
      </div>
    </div>

    <!-- Volume Chart -->
    <div class="card">
      <h2 class="section-title">
        <span class="icon">ğŸ“Š</span>
        Napi forgalom
      </h2>
      <div class="chart-card">
        <canvas id="volumeChart"></canvas>
      </div>
    </div>

    <!-- Distribution Chart -->
    <div class="card">
      <h2 class="section-title">
        <span class="icon">ğŸ¥§</span>
        TranzakciÃ³ tÃ­pusok
      </h2>
      <div class="chart-card" style="max-width:300px;margin:0 auto;">
        <canvas id="typeChart"></canvas>
      </div>
    </div>

    <!-- Features -->
    <div class="card">
      <h2 class="section-title">
        <span class="icon">ğŸ”§</span>
        Analitikai funkciÃ³k
      </h2>
      
      <ul class="info-list">
        <li><span class="emoji">ğŸ“Š</span> ValÃ³s idejÅ± tranzakciÃ³ monitoring</li>
        <li><span class="emoji">ğŸ“ˆ</span> Napi, heti, havi Ã¶sszesÃ­tÃ©sek</li>
        <li><span class="emoji">ğŸ¥§</span> VizuÃ¡lis kimutatÃ¡sok (Chart.js)</li>
        <li><span class="emoji">ğŸ“‰</span> Trend elemzÃ©sek</li>
        <li><span class="emoji">ğŸ”</span> RÃ©szletes szÅ±rÃ©si lehetÅ‘sÃ©gek</li>
        <li><span class="emoji">ğŸ“¤</span> Adatok exportÃ¡lÃ¡sa (CSV, PDF)</li>
      </ul>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../theme.js"></script>
  <script src="../app.js"></script>
  <script>
    function logout() {
      if (confirm('Biztosan ki szeretnÃ©l jelentkezni?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userName');
        localStorage.removeItem('loginTime');
        window.location.href = '../login.html';
      }
    }

    async function loadAnalytics() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const response = await fetch('/api/transactions?limit=100', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();
        
        if (!data.success || !data.transactions) return;

        const transactions = data.transactions;
        
        // Calculate stats
        const totalVolume = transactions.reduce((sum, tx) => sum + tx.amount, 0);
        const avgAmount = transactions.length ? Math.round(totalVolume / transactions.length) : 0;
        
        document.getElementById('total-transactions').textContent = transactions.length;
        document.getElementById('total-volume').textContent = (totalVolume / 1000).toFixed(1) + 'K';
        document.getElementById('avg-amount').textContent = avgAmount.toLocaleString('hu-HU');

        // Daily volume chart
        const dailyData = {};
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const key = date.toLocaleDateString('hu-HU', { month: 'short', day: 'numeric' });
          last7Days.push(key);
          dailyData[key] = 0;
        }

        transactions.forEach(tx => {
          const day = new Date(tx.createdAt).toLocaleDateString('hu-HU', { month: 'short', day: 'numeric' });
          if (dailyData.hasOwnProperty(day)) {
            dailyData[day] += tx.amount;
          }
        });

        new Chart(document.getElementById('volumeChart'), {
          type: 'line',
          data: {
            labels: last7Days,
            datasets: [{
              label: 'Forgalom (HUF)',
              data: last7Days.map(day => dailyData[day]),
              borderColor: '#00d4aa',
              backgroundColor: 'rgba(0, 212, 170, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 3,
              pointRadius: 6,
              pointBackgroundColor: '#00d4aa'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.1)' },
                ticks: { color: '#888' }
              },
              x: {
                grid: { display: false },
                ticks: { color: '#888' }
              }
            }
          }
        });

        // Type chart (sent vs received)
        // We need current user to determine direction
        const userRes = await fetch('/api/user/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        let sentCount = 0, receivedCount = 0;
        if (userRes.ok) {
          const userData = await userRes.json();
          const currentUsername = userData.user?.username || userData.user?.email || '';
          
          transactions.forEach(tx => {
            const fromUsername = tx.fromUser?.username || tx.fromUser?.email || '';
            if (fromUsername === currentUsername) sentCount++;
            else receivedCount++;
          });
        }

        new Chart(document.getElementById('typeChart'), {
          type: 'doughnut',
          data: {
            labels: ['KÃ¼ldÃ¶tt', 'Fogadott'],
            datasets: [{
              data: [sentCount, receivedCount],
              backgroundColor: ['#ef4444', '#00d4aa'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#888', padding: 20 }
              }
            }
          }
        });

      } catch (error) {
        console.error('Failed to load analytics:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', loadAnalytics);
  </script>
</body>
</html>
